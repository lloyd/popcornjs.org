(function(n,f){var o=n.document,p=n.location,q=/:\/\//,r=p.href.replace(p.href.split("/").slice(-1)[0],""),m=function(c,d,a){c=c||0;d=(d||c||0)+1;a=a||1;d=Math.ceil((d-c)/a)||0;var i=0,b=[];for(b.length=d;i<d;){b[i++]=c;c+=a}return b};f.sequence=function(c,d){return new f.sequence.init(c,d)};f.sequence.init=function(c,d){this.parent=o.getElementById(c);this.seqId=f.guid("__sequenced");this.queue=[];this.playlist=[];this.inOuts={ofVideos:[],ofClips:[]};this.dims={width:0,height:0};this.active=0;this.playing=
this.cycling=false;this.times={last:0};this.events={};var a=this,i=0;f.forEach(d,function(b,e){var h=o.createElement("video");h.preload="auto";h.controls=true;h.style.display=e&&"none"||"";h.id=a.seqId+"-"+e;a.queue.push(h);var g=b["in"],j=b.out;a.inOuts.ofVideos.push({"in":g!==undefined&&g||1,out:j!==undefined&&j||0});a.inOuts.ofVideos[e].out=a.inOuts.ofVideos[e].out||a.inOuts.ofVideos[e]["in"]+2;h.src=!q.test(b.src)?r+b.src:b.src;h.setAttribute("data-sequence-owner",c);h.setAttribute("data-sequence-guid",
a.seqId);h.setAttribute("data-sequence-id",e);h.setAttribute("data-sequence-clip",[a.inOuts.ofVideos[e]["in"],a.inOuts.ofVideos[e].out].join(":"));a.parent.appendChild(h);a.playlist.push(f("#"+h.id))});a.inOuts.ofVideos.forEach(function(b){b={"in":i,out:i+(b.out-b["in"])};a.inOuts.ofClips.push(b);i=b.out+1});f.forEach(this.queue,function(b,e){function h(){if(!e){a.dims.width=b.videoWidth;a.dims.height=b.videoHeight}b.currentTime=a.inOuts.ofVideos[e]["in"]-0.5;b.removeEventListener("canplaythrough",
h,false);return true}b.addEventListener("canplaythrough",h,false);b.addEventListener("play",function(){a.playing=true},false);b.addEventListener("pause",function(){a.playing=false},false);b.addEventListener("timeupdate",function(g){g=g.srcElement||g.target;g=+(g.dataset&&g.dataset.sequenceId||g.getAttribute("data-sequence-id"));var j=Math.floor(b.currentTime);if(a.times.last!==j&&g===a.active){a.times.last=j;j===a.inOuts.ofVideos[g].out&&f.sequence.cycle.call(a,g)}},false)});return this};f.sequence.init.prototype=
f.sequence.prototype;f.sequence.cycle=function(c){this.queue||f.error("Popcorn.sequence.cycle is not a public method");var d=this.queue,a=this.inOuts.ofVideos,i=d[c],b=0,e;if(d[c+1])b=c+1;if(d[c+1]){d=d[b];a=a[b];f.extend(d,{width:this.dims.width,height:this.dims.height});e=this.playlist[b];i.pause();this.active=b;this.times.last=a["in"]-1;e.currentTime(a["in"]);e[b?"play":"pause"]();this.trigger("cycle",{position:{previous:c,current:b}});if(b){i.style.display="none";d.style.display=""}this.cycling=
false}else this.playlist[c].pause();return this};var s=["timeupdate","play","pause"];f.extend(f.sequence.prototype,{eq:function(c){return this.playlist[c]},remove:function(){this.parent.innerHTML=null},clip:function(c){return this.inOuts.ofVideos[c]},duration:function(){for(var c=0,d=this.inOuts.ofClips,a=0;a<d.length;a++)c+=d[a].out-d[a]["in"]+1;return c-1},play:function(){this.playlist[this.active].play();return this},exec:function(c,d){var a=this.active;this.inOuts.ofClips.forEach(function(i,b){if(c>=
i["in"]&&c<=i.out)a=b});c+=this.inOuts.ofVideos[a]["in"]-this.inOuts.ofClips[a]["in"];f.addTrackEvent(this.playlist[a],{start:c-1,end:c,_running:false,_natives:{start:d||f.nop,end:f.nop,type:"exec"}});return this},listen:function(c,d){var a=this,i=this.playlist,b=i.length,e=0;if(!d)d=f.nop;if(f.Events.Natives.indexOf(c)>-1)f.forEach(i,function(h){h.listen(c,function(g){g.active=a;if(s.indexOf(c)>-1)d.call(h,g);else++e===b&&d.call(h,g)})});else{this.events[c]||(this.events[c]={});i=d.name||f.guid("__"+
c);this.events[c][i]=d}return this},unlisten:function(){},trigger:function(c,d){var a=this;if(!(f.Events.Natives.indexOf(c)>-1)){this.events[c]&&f.forEach(this.events[c],function(i){i.call(a,{type:c},d)});return this}}});f.forEach(f.manifest,function(c,d){f.sequence.prototype[d]=function(a){var i={},b=[],e,h,g,j,k;for(e=0;e<this.inOuts.ofClips.length;e++){b=this.inOuts.ofClips[e];h=m(b["in"],b.out);g=h.indexOf(a.start);j=h.indexOf(a.end);if(g>-1)i[e]=f.extend({},b,{start:h[g],clipIdx:g});if(j>-1)i[e]=
f.extend({},b,{end:h[j],clipIdx:j})}e=Object.keys(i).map(function(t){return+t});b=m(e[0],e[1]);for(e=0;e<b.length;e++){g={};j=b[e];var l=i[j];if(l){k=this.inOuts.ofVideos[j];h=l.clipIdx;k=m(k["in"],k.out);if(l.start){g.start=k[h];g.end=k[k.length-1]}if(l.end){g.start=k[0];g.end=k[h]}}else{g.start=this.inOuts.ofVideos[j]["in"];g.end=this.inOuts.ofVideos[j].out}this.playlist[j][d](f.extend({},a,g))}return this}})})(this,Popcorn);
