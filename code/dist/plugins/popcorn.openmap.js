(function(n){function s(b,c){if(b.map)b.map.div.style.display=c;else setTimeout(function(){s(b,c)},10)}var w=1;n.plugin("openmap",function(b){var c,i,f,h,j,l,m,t,o=document.getElementById(b.target);c=document.createElement("div");c.id="openmapdiv"+w;c.style.width="100%";c.style.height="100%";w++;if(!o&&n.plugin.debug)throw Error("target container doesn't exist");o&&o.appendChild(c);t=function(){if(window.OpenLayers){if(b.location){location=new OpenLayers.LonLat(0,0);n.getJSONP("http://tinygeocoder.com/create-api.php?q="+
b.location+"&callback=jsonp",function(g){i=new OpenLayers.LonLat(g[1],g[0]);b.map.setCenter(i)})}else i=new OpenLayers.LonLat(b.lng,b.lat);b.type=b.type||"ROADMAP";if(b.type==="SATELLITE"){b.map=new OpenLayers.Map({div:c,maxResolution:0.28125,tileSize:new OpenLayers.Size(512,512)});var a=new OpenLayers.Layer.WorldWind("LANDSAT","http://worldwind25.arc.nasa.gov/tile/tile.aspx",2.25,4,{T:"105"});b.map.addLayer(a);h=new OpenLayers.Projection("EPSG:4326");f=new OpenLayers.Projection("EPSG:4326")}else if(b.type===
"TERRAIN"){h=new OpenLayers.Projection("EPSG:4326");f=new OpenLayers.Projection("EPSG:4326");b.map=new OpenLayers.Map({div:c,projection:f});a=new OpenLayers.Layer.WMS("USGS Terraserver","http://terraserver-usa.org/ogcmap.ashx?",{layers:"DRG"});b.map.addLayer(a)}else{f=new OpenLayers.Projection("EPSG:900913");h=new OpenLayers.Projection("EPSG:4326");i=i.transform(h,f);b.map=new OpenLayers.Map({div:c,projection:f,displayProjection:h});a=new OpenLayers.Layer.OSM;b.map.addLayer(a)}if(b.map)b.map.div.style.display=
"none"}else setTimeout(function(){t()},50)};t();return{_setup:function(a){window.OpenLayers||n.getScript("http://openlayers.org/api/OpenLayers.js");var g=function(){if(a.map){a.zoom=a.zoom||2;if(a.zoom&&typeof a.zoom!=="number")a.zoom=+a.zoom;a.map.setCenter(i,a.zoom);if(a.markers){var u=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]),x=function(d){clickedFeature=d.feature;if(clickedFeature.attributes.text){m=new OpenLayers.Popup.FramedCloud("featurePopup",clickedFeature.geometry.getBounds().getCenterLonLat(),
new OpenLayers.Size(120,250),clickedFeature.attributes.text,null,true,function(){l.unselect(this.feature)});clickedFeature.popup=m;m.feature=clickedFeature;a.map.addPopup(m)}},y=function(d){feature=d.feature;if(feature.popup){m.feature=null;a.map.removePopup(feature.popup);feature.popup.destroy();feature.popup=null}},z=function(d){n.getJSONP("http://tinygeocoder.com/create-api.php?q="+d.location+"&callback=jsonp",function(k){k=(new OpenLayers.Geometry.Point(k[1],k[0])).transform(h,f);var p=OpenLayers.Util.extend({},
u);if(!d.size||isNaN(d.size))d.size=14;p.pointRadius=d.size;p.graphicOpacity=1;p.externalGraphic=d.icon;k=new OpenLayers.Feature.Vector(k,null,p);if(d.text)k.attributes={text:d.text};j.addFeatures([k])})};j=new OpenLayers.Layer.Vector("Point Layer",{style:u});a.map.addLayer(j);for(var v=0,A=a.markers.length;v<A;v++){var e=a.markers[v];if(e.text)if(!l){l=new OpenLayers.Control.SelectFeature(j);a.map.addControl(l);l.activate();j.events.on({featureselected:x,featureunselected:y})}if(e.location)z(e);
else{var q=(new OpenLayers.Geometry.Point(e.lng,e.lat)).transform(h,f),r=OpenLayers.Util.extend({},u);if(!e.size||isNaN(e.size))e.size=14;r.pointRadius=e.size;r.graphicOpacity=1;r.externalGraphic=e.icon;q=new OpenLayers.Feature.Vector(q,null,r);if(e.text)q.attributes={text:e.text};j.addFeatures([q])}}}}else setTimeout(function(){g()},13)};g()},start:function(a,g){s(g,"block")},end:function(a,g){s(g,"none")},_teardown:function(){o&&o.removeChild(c);c=map=i=f=h=j=l=m=null}}},{about:{name:"Popcorn OpenMap Plugin",
version:"0.3",author:"@mapmeld",website:"mapadelsur.blogspot.com"},options:{start:{elem:"input",type:"text",label:"In"},end:{elem:"input",type:"text",label:"Out"},target:"map-container",type:{elem:"select",options:["ROADMAP","SATELLITE","TERRAIN"],label:"Type"},zoom:{elem:"input",type:"text",label:"Zoom"},lat:{elem:"input",type:"text",label:"Lat"},lng:{elem:"input",type:"text",label:"Lng"},location:{elem:"input",type:"text",label:"Location"},markers:{elem:"input",type:"text",label:"List Markers"}}})})(Popcorn);
