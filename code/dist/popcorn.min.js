/*
 * popcorn.js version 0.8
 * http://popcornjs.org
 *
 * Copyright 2011, Mozilla Foundation
 * Licensed under the MIT license
 */

(function(o,n){function x(a){a=typeof a==="string"?a:[a.language,a.region].join("-");var c=a.split("-");return{iso6391:a,language:c[0]||"",region:c[1]||""}}var y=Array.prototype,z=Object.prototype,A=y.forEach,F=y.slice,B=z.hasOwnProperty,C=z.toString,G=/^(#([\w\-\_\.]+))$/,t=[],D=false,r={events:{hash:{},apis:{}}},b=function(a,c){return new b.p.init(a,c||null)};b.instances=[];b.instanceIds={};b.removeInstance=function(a){if(b.instances.length){b.instances.splice(b.instanceIds[a.id],1);delete b.instanceIds[a.id];
return b.instances}};b.addInstance=function(a){var c=b.instances.length,e=a.media.id&&a.media.id;a.id=!(e in b.instanceIds)&&e||"__popcorn"+c;b.instanceIds[a.id]=c;b.instances.push(a);return b.instances};b.getInstanceById=function(a){return b.instances[b.instanceIds[a]]};b.removeInstanceById=function(a){return b.removeInstance(b.instances[b.instanceIds[a]])};b.p=b.prototype={init:function(a,c){var e;if(typeof a==="function")if(n.readyState==="interactive"||n.readyState==="complete")a(n,b);else{t.push(a);
if(!D){D=true;var f=function(){n.removeEventListener("DOMContentLoaded",f,false);for(var g=0,h=t.length;g<h;g++)t[g].call(n,b);t=null};n.addEventListener("DOMContentLoaded",f,false)}}else{this.media=(e=G.exec(a))&&e.length&&e[2]?n.getElementById(e[2]):a;this[this.media.nodeName&&this.media.nodeName.toLowerCase()||"video"]=this.media;b.addInstance(this);this.options=c||{};this.data={disabled:[],events:{},hooks:{},history:[],state:{volume:this.media.volume},trackRefs:{},trackEvents:{byStart:[{start:-1,
end:-1}],byEnd:[{start:-1,end:-1}],startIndex:0,endIndex:0,previousUpdateTime:-1}};var d=function(g){if(g.media.readyState>=2){var h=g.media.duration;h=h!=h?Number.MAX_VALUE:h+1;b.addTrackEvent(g,{start:h,end:h});g.media.addEventListener("timeupdate",function(j){b.timeUpdate(g,j)},false)}else o.setTimeout(function(){d(g)},1)};d(this);return this}}};b.p.init.prototype=b.p;b.forEach=function(a,c,e){if(!a||!c)return{};e=e||this;var f,d;if(A&&a.forEach===A)return a.forEach(c,e);if(C.call(a)==="[object NodeList]"){f=
0;for(d=a.length;f<d;f++)c.call(e,a[f],f,a);return a}for(f in a)B.call(a,f)&&c.call(e,a[f],f,a);return a};b.extend=function(a){var c=F.call(arguments,1);b.forEach(c,function(e){for(var f in e)a[f]=e[f]});return a};b.extend(b,{error:function(a){throw Error(a);},guid:function(a){b.guid.counter++;return(a?a:"")+(+new Date+b.guid.counter)},sizeOf:function(a){var c=0,e;for(e in a)c++;return c},isArray:Array.isArray||function(a){return C.call(a)==="[object Array]"},nop:function(){},position:function(a){a=
a.getBoundingClientRect();var c={},e=n.documentElement,f=n.body,d,g,h;d=e.clientTop||f.clientTop||0;g=e.clientLeft||f.clientLeft||0;h=o.pageYOffset&&e.scrollTop||f.scrollTop;e=o.pageXOffset&&e.scrollLeft||f.scrollLeft;d=Math.ceil(a.top+h-d);g=Math.ceil(a.left+e-g);for(var j in a)c[j]=Math.round(a[j]);return b.extend({},c,{top:d,left:g})},disable:function(a,c){var e=a.data.disabled;e.indexOf(c)===-1&&e.push(c);return a},enable:function(a,c){var e=a.data.disabled,f=e.indexOf(c);f>-1&&e.splice(f,1);
return a}});b.guid.counter=1;b.extend(b.p,function(){var a={};b.forEach("load play pause currentTime playbackRate volume duration preload playbackRate autoplay loop controls muted buffered readyState seeking paused played seekable ended".split(/\s+/g),function(c){a[c]=function(e){if(typeof this.media[c]==="function"){this.media[c]();return this}if(e!=null){this.media[c]=e;return this}return this.media[c]}});return a}());b.forEach("enable disable".split(" "),function(a){b.p[a]=function(c){return b[a](this,
c)}});b.extend(b.p,{roundTime:function(){return-~this.media.currentTime},exec:function(a,c){b.addTrackEvent(this,{start:a,end:a+1,_running:false,_natives:{start:c||b.nop,end:b.nop,type:"exec"}});return this},mute:function(a){a=a==null||a===true?"muted":"unmuted";if(a==="unmuted"){this.media.muted=false;this.media.volume=this.data.state.volume}if(a==="muted"){this.data.state.volume=this.media.volume;this.media.muted=true}this.trigger(a);return this},unmute:function(a){return this.mute(a==null?false:
!a)},position:function(){return b.position(this.media)},toggle:function(a){return b[this.data.disabled.indexOf(a)>-1?"enable":"disable"](this,a)},defaults:function(a,c){if(b.isArray(a)){b.forEach(a,function(e){for(var f in e)this.defaults(f,e[f])},this);return this}if(!this.options.defaults)this.options.defaults={};this.options.defaults[a]||(this.options.defaults[a]={});b.extend(this.options.defaults[a],c);return this}});b.Events={UIEvents:"blur focus focusin focusout load resize scroll unload",MouseEvents:"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave click dblclick",
Events:"loadstart progress suspend emptied stalled play pause loadedmetadata loadeddata waiting playing canplay canplaythrough seeking seeked timeupdate ended ratechange durationchange volumechange"};b.Events.Natives=b.Events.UIEvents+" "+b.Events.MouseEvents+" "+b.Events.Events;r.events.apiTypes=["UIEvents","MouseEvents","Events"];(function(a,c){for(var e=r.events.apiTypes,f=a.Natives.split(/\s+/g),d=0,g=f.length;d<g;d++)c.hash[f[d]]=true;e.forEach(function(h){c.apis[h]={};for(var j=a[h].split(/\s+/g),
k=j.length,l=0;l<k;l++)c.apis[h][j[l]]=true})})(b.Events,r.events);b.events={isNative:function(a){return!!r.events.hash[a]},getInterface:function(a){if(!b.events.isNative(a))return false;var c=r.events,e=c.apiTypes;c=c.apis;for(var f=0,d=e.length,g,h;f<d;f++){h=e[f];if(c[h][a]){g=h;break}}return g},all:b.Events.Natives.split(/\s+/g),fn:{trigger:function(a,c){var e;if(this.data.events[a]&&b.sizeOf(this.data.events[a])){if(e=b.events.getInterface(a)){e=n.createEvent(e);e.initEvent(a,true,true,o,1);
this.media.dispatchEvent(e);return this}b.forEach(this.data.events[a],function(f){f.call(this,c)},this)}return this},listen:function(a,c){var e=this,f=true,d=b.events.hooks[a],g;if(!this.data.events[a]){this.data.events[a]={};f=false}if(d){d.add&&d.add.call(this,{},c);if(d.bind)a=d.bind;if(d.handler){g=c;c=function(h){d.handler.call(e,h,g)}}f=true;if(!this.data.events[a]){this.data.events[a]={};f=false}}this.data.events[a][c.name||c.toString()+b.guid()]=c;!f&&b.events.all.indexOf(a)>-1&&this.media.addEventListener(a,
function(h){b.forEach(e.data.events[a],function(j){typeof j==="function"&&j.call(e,h)})},false);return this},unlisten:function(a,c){if(this.data.events[a]&&this.data.events[a][c]){delete this.data.events[a][c];return this}this.data.events[a]=null;return this}},hooks:{canplayall:{bind:"canplaythrough",add:function(a,c){var e=false;if(this.media.readyState){c.call(this,a);e=true}this.data.hooks.canplayall={fired:e}},handler:function(a,c){if(!this.data.hooks.canplayall.fired){c.call(this,a);this.data.hooks.canplayall.fired=
true}}}}};b.forEach(["trigger","listen","unlisten"],function(a){b.p[a]=b.events.fn[a]});b.protect={natives:"load play pause currentTime playbackRate mute volume duration removePlugin roundTime trigger listen unlisten execpreload playbackRate autoplay loop controls muted buffered readyState seeking paused played seekable ended".toLowerCase().split(/\s+/)};b.addTrackEvent=function(a,c){if(c&&c._natives&&c._natives.type&&a.options.defaults&&a.options.defaults[c._natives.type])c=b.extend({},a.options.defaults[c._natives.type],
c);if(c._natives){c._id=!c.id?b.guid(c._natives.type):c.id;a.data.history.push(c._id)}c.start=b.util.toSeconds(c.start,a.options.framerate);c.end=b.util.toSeconds(c.end,a.options.framerate);var e=a.data.trackEvents.byStart,f=a.data.trackEvents.byEnd,d;for(d=e.length-1;d>=0;d--)if(c.start>=e[d].start){e.splice(d+1,0,c);break}for(d=f.length-1;d>=0;d--)if(c.end>f[d].end){f.splice(d+1,0,c);break}c._id&&b.addTrackEvent.ref(a,c)};b.addTrackEvent.ref=function(a,c){a.data.trackRefs[c._id]=c;return a};b.removeTrackEvent=
function(a,c){var e=a.data.history.length,f=0,d=[],g=[],h=[];b.forEach(a.data.trackEvents.byStart,function(k,l){if(!k._id){d.push(a.data.trackEvents.byStart[l]);g.push(a.data.trackEvents.byEnd[l])}if(k._id){if(k._id!==c){d.push(a.data.trackEvents.byStart[l]);g.push(a.data.trackEvents.byEnd[l])}if(k._id===c){f=l;k._natives._teardown&&k._natives._teardown.call(a,k)}}});f<=a.data.trackEvents.startIndex&&a.data.trackEvents.startIndex--;f<=a.data.trackEvents.endIndex&&a.data.trackEvents.endIndex--;a.data.trackEvents.byStart=
d;a.data.trackEvents.byEnd=g;for(var j=0;j<e;j++)a.data.history[j]!==c&&h.push(a.data.history[j]);a.data.history=h;b.removeTrackEvent.ref(a,c)};b.removeTrackEvent.ref=function(a,c){delete a.data.trackRefs[c];return a};b.getTrackEvents=function(a){var c=[];a=a.data.trackEvents.byStart;for(var e=a.length,f=0,d;f<e;f++){d=a[f];d._id&&c.push(d)}return c};b.getTrackEvents.ref=function(a){return a.data.trackRefs};b.getTrackEvent=function(a,c){return a.data.trackRefs[c]};b.getTrackEvent.ref=function(a,c){return a.data.trackRefs[c]};
b.getLastTrackEventId=function(a){return a.data.history[a.data.history.length-1]};b.timeUpdate=function(a,c){var e=a.media.currentTime,f=a.data.trackEvents.previousUpdateTime,d=a.data.trackEvents,g=d.byEnd,h=d.byStart;if(f<e){for(;g[d.endIndex]&&g[d.endIndex].end<=e;)if(!g[d.endIndex]._natives||b.registryByName[g[d.endIndex]._natives.type]||a[g[d.endIndex]._natives.type]){if(g[d.endIndex]._running===true){g[d.endIndex]._running=false;g[d.endIndex]._natives.end.call(a,c,g[d.endIndex])}d.endIndex++}else{b.removeTrackEvent(a,
g[d.endIndex]._id);return}for(;h[d.startIndex]&&h[d.startIndex].start<=e;)if(!h[d.startIndex]._natives||b.registryByName[h[d.startIndex]._natives.type]||a[h[d.startIndex]._natives.type]){if(h[d.startIndex].end>e&&h[d.startIndex]._running===false&&a.data.disabled.indexOf(h[d.startIndex]._natives.type)===-1){h[d.startIndex]._running=true;h[d.startIndex]._natives.start.call(a,c,h[d.startIndex])}d.startIndex++}else{b.removeTrackEvent(a,h[d.startIndex]._id);return}}else if(f>e){for(;h[d.startIndex]&&h[d.startIndex].start>
e;)if(!h[d.startIndex]._natives||b.registryByName[h[d.startIndex]._natives.type]||a[h[d.startIndex]._natives.type]){if(h[d.startIndex]._running===true){h[d.startIndex]._running=false;h[d.startIndex]._natives.end.call(a,c,h[d.startIndex])}d.startIndex--}else{b.removeTrackEvent(a,h[d.startIndex]._id);return}for(;g[d.endIndex]&&g[d.endIndex].end>e;)if(!g[d.endIndex]._natives||b.registryByName[g[d.endIndex]._natives.type]||a[g[d.endIndex]._natives.type]){if(g[d.endIndex].start<=e&&g[d.endIndex]._running===
false&&a.data.disabled.indexOf(g[d.endIndex]._natives.type)===-1){g[d.endIndex]._running=true;g[d.endIndex]._natives.start.call(a,c,g[d.endIndex])}d.endIndex--}else{b.removeTrackEvent(a,g[d.endIndex]._id);return}}d.previousUpdateTime=e};b.extend(b.p,{getTrackEvents:function(){return b.getTrackEvents.call(null,this)},getTrackEvent:function(a){return b.getTrackEvent.call(null,this,a)},getLastTrackEventId:function(){return b.getLastTrackEventId.call(null,this)},removeTrackEvent:function(a){b.removeTrackEvent.call(null,
this,a);return this},removePlugin:function(a){b.removePlugin.call(null,this,a);return this},timeUpdate:function(a){b.timeUpdate.call(null,this,a);return this}});b.manifest={};b.registry=[];b.registryByName={};b.plugin=function(a,c,e){if(b.protect.natives.indexOf(a.toLowerCase())>=0)b.error("'"+a+"' is a protected function name");else{var f=["start","end"],d={},g=typeof c==="function",h=["_setup","_teardown","start","end"],j=function(m,i){m=m||b.nop;i=i||b.nop;return function(){m.apply(this,arguments);
i.apply(this,arguments)}};b.manifest[a]=e=e||c.manifest||{};h.forEach(function(m){c[m]=c[m]||b.nop});var k=function(m,i){if(!i)return this;var u=i._natives={},E="",p,s;b.extend(u,m);i._natives.type=a;i._running=false;p=this.options.defaults&&this.options.defaults[i._natives&&i._natives.type];i.compose=i.compose&&i.compose.split(" ")||[];i.effect=i.effect&&i.effect.split(" ")||[];i.compose=i.compose.concat(i.effect);i.compose.forEach(function(v){E=b.compositions[v]||{};h.forEach(function(q){u[q]=j(u[q],
E[q])})});i._natives.manifest=e;if(!("start"in i))i.start=0;if(!("end"in i))i.end=this.duration()||Number.MAX_VALUE;s=p?b.extend({},p,i):i;if(!s.target){p="options"in e&&e.options;s.target=p&&"target"in p&&p.target}i._natives._setup&&i._natives._setup.call(this,s);b.addTrackEvent(this,b.extend(s,i));b.forEach(m,function(v,q){q!=="type"&&f.indexOf(q)===-1&&this.listen(q,v)},this);return this};d[a]=function(m){return k.call(this,g?c.call(this,m):c,m)};b.extend(b.p,d);var l={fn:d[a],definition:c,base:c,
parents:[],name:a};b.registry.push(b.extend(d,l,{type:a}));b.registryByName[a]=l;return d}};b.plugin.debug=false;b.removePlugin=function(a,c){if(!c){c=a;a=b.p;if(b.protect.natives.indexOf(c.toLowerCase())>=0){b.error("'"+c+"' is a protected function name");return}var e=b.registry.length,f;for(f=0;f<e;f++)if(b.registry[f].name===c){b.registry.splice(f,1);delete b.registryByName[c];delete a[c];return}}e=a.data.trackEvents.byStart;f=a.data.trackEvents.byEnd;var d,g;d=0;for(g=e.length;d<g;d++)if(e[d]&&
e[d]._natives&&e[d]._natives.type===c&&f[d]&&f[d]._natives&&f[d]._natives.type===c){e[d]._natives._teardown&&e[d]._natives._teardown.call(a,e[d]);e.splice(d,1);f.splice(d,1);d--;g--;if(a.data.trackEvents.startIndex<=d){a.data.trackEvents.startIndex--;a.data.trackEvents.endIndex--}}};b.compositions={};b.compose=function(a,c,e){b.manifest[a]=e||c.manifest||{};b.compositions[a]=c};b.plugin.effect=b.effect=b.compose;b.parsers={};b.parser=function(a,c,e){if(b.protect.natives.indexOf(a.toLowerCase())>=
0)b.error("'"+a+"' is a protected function name");else{if(typeof c==="function"&&!e){e=c;c=""}if(!(typeof e!=="function"||typeof c!=="string")){var f={};f[a]=function(d,g){if(!d)return this;var h=this;b.xhr({url:d,dataType:c,success:function(j){var k,l,m=0;j=e(j).data||[];if(k=j.length){for(;m<k;m++){l=j[m];for(var i in l)B.call(l,i)&&h[i]&&h[i](l[i])}g&&g()}}});return this};b.extend(b.p,f);return f}}};var H=/\?/,I={url:"",data:"",dataType:"",success:b.nop,type:"GET",async:true,xhr:function(){return new o.XMLHttpRequest}};
b.xhr=function(a){a.dataType=a.dataType&&a.dataType.toLowerCase()||null;if(a.dataType&&(a.dataType==="jsonp"||a.dataType==="script"))b.xhr.getJSONP(a.url,a.success,a.dataType==="script");else{a=b.extend({},I,a);a.ajax=a.xhr();if(a.ajax){if(a.type==="GET"&&a.data){a.url+=(H.test(a.url)?"&":"?")+a.data;a.data=null}a.ajax.open(a.type,a.url,a.async);a.ajax.send(a.data||null);return b.xhr.httpData(a)}}};b.xhr.httpData=function(a){var c,e=null;a.ajax.onreadystatechange=function(){if(a.ajax.readyState===
4){try{e=JSON.parse(a.ajax.responseText)}catch(f){}c={xml:a.ajax.responseXML,text:a.ajax.responseText,json:e};if(a.dataType)c=c[a.dataType];a.success.call(a.ajax,c)}};return c};b.xhr.getJSONP=function(a,c,e){if(e)if(n.querySelectorAll('script[src="'+a+'"]').length){c&&c(true);return}var f=n.head||n.getElementsByTagName("head")[0]||n.documentElement,d=n.createElement("script"),g=a.split("?")[1],h=false,j=[],k,l;if(g&&!e)j=g.split("&");if(j.length)l=j[j.length-1].split("=");k=j.length?l[1]?l[1]:l[0]:
"jsonp";if(!g&&!e)a+="?callback="+k;if(k&&!e){if(window[k])k=b.guid(k);window[k]=function(m){c&&c(m);h=true};a=a.replace(l.join("="),l[0]+"="+k)}d.onload=d.onreadystatechange=function(){if(!d.readyState||/loaded|complete/.test(d.readyState)){e&&c&&c();if(h){delete window[k];f.removeChild(d)}}};d.src=a;f.insertBefore(d,f.firstChild)};b.getJSONP=b.xhr.getJSONP;b.getScript=b.xhr.getScript=function(a,c){return b.xhr.getJSONP(a,c,true)};b.util={toSeconds:function(a,c){var e=/^([0-9]+:){0,2}[0-9]+([.;][0-9]+)?$/,
f,d,g;if(typeof a==="number")return a;typeof a==="string"&&!e.test(a)&&b.error("Invalid time format");e=a.split(":");f=e.length-1;d=e[f];if(d.indexOf(";")>-1){d=d.split(";");g=0;if(c&&typeof c==="number")g=parseFloat(d[1],10)/c;e[f]=parseInt(d[0],10)+g}f=e[0];return{1:parseFloat(f,10),2:parseInt(f,10)*60+parseFloat(e[1],10),3:parseInt(f,10)*3600+parseInt(e[1],10)*60+parseFloat(e[2],10)}[e.length||1]}};var w=x(o.navigator.userLanguage||o.navigator.language);b.locale={get:function(){return w},set:function(a){w=
x(a);b.locale.broadcast();return w},broadcast:function(a){var c=b.instances,e=c.length,f=0,d;for(a=a||"locale:changed";f<e;f++){d=c[f];a in d.data.events&&d.trigger(a)}}};o.Popcorn=b;n.addEventListener("DOMContentLoaded",function(){var a=n.querySelectorAll("[data-timeline-sources]");b.forEach(a,function(c,e){var f=a[e],d,g,h;if(!f.id)f.id=b.guid("__popcorn");if(f.nodeType&&f.nodeType===1){h=b("#"+f.id);d=(f.getAttribute("data-timeline-sources")||"").split(",");d[0]&&b.forEach(d,function(j){g=j.split("!");
if(g.length===1){g=j.split(".");g[0]="parse"+g[g.length-1].toUpperCase();g[1]=j}d[0]&&h[g[0]]&&h[g[0]](g[1])});h.autoplay&&h.play()}})},false)})(window,window.document);
